<!-- chapter03/templates/inde.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Flask Restful API Example</title>
    <script src="/static/jquery.min.js"></script>                             <!--(1)-->
    <script type="text/javascript">

    // GET request to server to retrieve water pump state.
    function getState() {
        $.get("/pump", function(serverResponse, status) {                       // (2)
           console.log(serverResponse)
           updateControls(serverResponse)                                      // (3)
        });
    }


    // POST Request to server to set water pump state.
    function postUpdate(payload) {
        $.post("/pump", payload, function(serverResponse, status) {
            console.log(serverResponse);
            updateControls(serverResponse);
        });
    }


    function updateControls(data) {
        str = "";
        if (data.level == 0) 
            str = "off"
        else
            str = "on"
        $("input[type=range].pumpState").val(data.level);
        $("#pumpState").html(str);
    }


    $(document).ready(function() {
        // Event listener for Slider value changes.
        // .on('input', ...) will fire as the slider changes (= lots of network traffic). Change to
        // .on('change', ...) to fire only after mouse button is released.
        $("input[type=range].pumpState").on('input', function() {        // (7)
               pump_state = $(this).val();                               // (8)
               payload = { "level": pump_state }                         // (9)
               postUpdate(payload);
            });

        // Initialise slider value form state on server.
        getState()                                                             // (10)
    });

    </script>

</head>

<body>
    <h1>Flask RESTful API Example</h1>
    LED is connected to GPIO {{pin}}<br>                                      <!--(11)-->
    Irrigation: <span id="pumpState"></span>%<br>
    <input type="range" min="0" max="1" value="0" class="pumpState">  <!--(12)-->
</body>

</html>
